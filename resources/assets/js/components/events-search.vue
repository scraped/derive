<template>
    <div class="container">
        <div class="row" v-if="showEvent && !!event">
            <div class="col-md-8 col-md-offset-2">
                <div class="event card">
                    <!--<img class="card-img-top" src="..." alt="Card image cap">-->
                    <div class="card-block">
                        <h1 class="card-title">{{ event.name }}</h1>
                        <h2 class="card-text">
                            {{ event.startTime.calendar() }}
                            <span v-if="event.endTime"> until {{ event.endTime.calendar() }}</span>
                        </h2>
                        <div class="card-text address" v-if="event.place">
                            <h3>{{ event.place.name }}</h3>
                            {{ event.place.location.street }}
                            <br>
                            {{ event.place.location.city }}, {{ event.place.location.state }} {{ event.place.location.zip }}
                        </div>
                        <p class="card-text">{{ event.description }}</p>
                    </div>
                </div>
                <div class="form-inline">
                    <div class="form-group">
                        <input type="button" class="btn btn-lg btn-primary" value="Reroll" v-on:click="search">
                    </div>
                </div>
            </div>
        </div>
        <div class="row" v-if="!showEvent">
            <div class="col-md-8 col-md-offset-2">
                <div class="form-group">
                    <gmap-autocomplete @place_changed="setPlace" :selectFirstOnEnter="true" class="form-control">
                    </gmap-autocomplete>
                </div>
                <gmap-map
                    :center="center"
                    :zoom="7"
                    map-type-id="terrain"
                    style="width: 500px; height: 300px; margin: 0 auto;">
                    <gmap-marker :position="marker">
                    </gmap-marker>
                </gmap-map>
            </div>
            <div class="col-md-8 col-md-offset-2" style="padding-top:20px">
                <div class="form-inline">
                    <div class="form-group">
                        <input type="button" class="btn btn-lg btn-primary" value="Roll" v-on:click="search">
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
    import * as VueGoogleMaps from 'vue2-google-maps';
    import Vue from 'vue';

    const moment = require('moment');

    Vue.use(VueGoogleMaps, {
        load: {
            key: 'AIzaSyDBBuh9aUBOJuO0yGB0EDaSz5HmD8lnXKY',
            libraries: 'places'
        }
    });

    export default {
        data() {
            var center = {lat: 33.4483771, lng: -112.07403729999999};
            var marker = {lat: 33.4483771, lng: -112.07403729999999};

            return {
                center,
                marker,
                event: {},
                showEvent: false
            };
        },

        mounted() {
            if (!navigator.geolocation)
                return;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    this.$set(this.center, 'lat', position.coords.latitude);
                    this.$set(this.center, 'lng', position.coords.longitude);
                    this.$set(this.marker, 'lat', position.coords.latitude);
                    this.$set(this.marker, 'lng', position.coords.longitude);
                    this.enabled = true;
                });
        },

        methods: {
            search() {
                const {lat, lng} = this.marker;

                axios.get('/events/search', {
                    params: {
                        lat,
                        lng,
                        date:  moment().format()
                    }
                })
                    .then((response) => {
                        this.showEvent = true;

                        const event = response.data;
                        this.event = event;

                        console.log(event);

                        this.$set(this.event, 'startTime', moment(event.startTime));
                        if (event.endTime)
                            this.$set(this.event, 'endTime', moment(event.endTime));
                    });
            },

            setPlace(place) {
                const lat = place.geometry.location.lat();
                const lng = place.geometry.location.lng();
                this.$set(this.center, 'lat', lat);
                this.$set(this.center, 'lng', lng);
                this.$set(this.marker, 'lat', lat);
                this.$set(this.marker, 'lng', lng);
            }
        }
    }
</script>
